import cv2
import os

EDGE_DIR = "edge"
ROI_DIR = "step5_roi_cropped"

os.makedirs(ROI_DIR, exist_ok=True)

current_img = None
roi_list = []
drawing = False
start_point = None

def mouse_callback(event, x, y, flags, param):
    global drawing, start_point, current_img, roi_list
    
    img_display = current_img.copy()
    
    for idx, roi in enumerate(roi_list):
        cv2.rectangle(img_display, (roi[0], roi[1]), (roi[2], roi[3]), (0, 255, 0), 3)
        cv2.putText(img_display, f"#{idx+1}", (roi[0], roi[1]-10), 
                   cv2.FONT_HERSHEY_SIMPLEX, 1.0, (0, 255, 0), 3)
    
    if event == cv2.EVENT_LBUTTONDOWN:
        drawing = True
        start_point = (x, y)
    
    elif event == cv2.EVENT_MOUSEMOVE:
        if drawing:
            img_temp = img_display.copy()
            cv2.rectangle(img_temp, start_point, (x, y), (0, 0, 255), 3)
            cv2.imshow('BUOC 5: Crop ROI', img_temp)
    
    elif event == cv2.EVENT_LBUTTONUP:
        drawing = False
        end_point = (x, y)
        
        x1 = min(start_point[0], end_point[0])
        y1 = min(start_point[1], end_point[1])
        x2 = max(start_point[0], end_point[0])
        y2 = max(start_point[1], end_point[1])
        
        if x2 - x1 > 100 and y2 - y1 > 30:
            roi_list.append((x1, y1, x2, y2))
            print(f"   âœ… ROI #{len(roi_list)}")
        
        cv2.rectangle(img_display, (x1, y1), (x2, y2), (0, 255, 0), 3)
        cv2.putText(img_display, f"#{len(roi_list)}", (x1, y1-10), 
                   cv2.FONT_HERSHEY_SIMPLEX, 1.0, (0, 255, 0), 3)
        cv2.imshow('BUOC 5: Crop ROI', img_display)

def process(img_path, fname):
    global current_img, roi_list
    
    print(f"\n{'='*70}")
    print(f"ğŸ“¸ {fname}")
    print(f"{'='*70}")
    
    img = cv2.imread(img_path, cv2.IMREAD_GRAYSCALE)
    if img is None:
        print("âŒ Lá»—i")
        return
    
    current_img = cv2.cvtColor(img, cv2.COLOR_GRAY2BGR)
    roi_list = []
    
    cv2.namedWindow('BUOC 5: Crop ROI', cv2.WINDOW_NORMAL)
    cv2.resizeWindow('BUOC 5: Crop ROI', 1400, 900)
    cv2.setMouseCallback('BUOC 5: Crop ROI', mouse_callback)
    cv2.imshow('BUOC 5: Crop ROI', current_img)
    
    print("\nğŸ“Œ Click + kÃ©o chá»n ROI | SPACE=lÆ°u | r=reset | q=skip")
    
    while True:
        key = cv2.waitKey(1) & 0xFF
        if key == ord(' '):
            break
        elif key == ord('q'):
            roi_list = []
            break
        elif key == ord('r'):
            roi_list = []
            cv2.imshow('BUOC 5: Crop ROI', current_img)
            print("   ğŸ”„ Reset")
    
    cv2.destroyAllWindows()
    
    if len(roi_list) == 0:
        print("   â­ï¸  Skip")
        return
    
    print(f"\n   âœ‚ï¸  LÆ°u {len(roi_list)} ROI...")
    
    base = os.path.splitext(fname)[0]
    
    for idx, (x1, y1, x2, y2) in enumerate(roi_list):
        roi = img[y1:y2, x1:x2]
        roi_file = f"{base}_ROI_{idx+1}.png"
        cv2.imwrite(os.path.join(ROI_DIR, roi_file), roi)
        print(f"      âœ… {roi_file}")

# MAIN
if not os.path.isdir(EDGE_DIR):
    print(f"âŒ ChÆ°a cÃ³ {EDGE_DIR}")
    print("ğŸ’¡ Cháº¡y create_edge.py trÆ°á»›c!")
else:
    files = sorted([f for f in os.listdir(EDGE_DIR) if f.lower().endswith(('.jpg', '.png', '.jpeg'))])
    
    if len(files) == 0:
        print("âŒ KhÃ´ng cÃ³ áº£nh")
    else:
        print(f"\nğŸ¯ BÆ¯á»šC 5: CROP ROI")
        print(f"{'='*70}")
        print(f"CÃ³ {len(files)} áº£nh\n")
        
        for i, f in enumerate(files[:10]):
            print(f"  [{i+1}] {f}")
        if len(files) > 10:
            print(f"  ... +{len(files)-10}")
        print(f"{'='*70}")
        
        while True:
            s = input(f"\nâ–¶ï¸  Báº¯t Ä‘áº§u tá»«? (1-{len(files)}) [Enter=1]: ").strip()
            if s == "":
                idx = 0
                break
            try:
                idx = int(s) - 1
                if 0 <= idx < len(files):
                    break
            except:
                pass
            print(f"âŒ Nháº­p 1-{len(files)}")
        
        for i in range(idx, len(files)):
            print(f"\n[{i+1}/{len(files)}]")
            process(os.path.join(EDGE_DIR, files[i]), files[i])

print(f"\n{'='*70}")
print(f"âœ… XONG! ROI: {ROI_DIR}/")
