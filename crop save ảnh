import cv2
import os
import numpy as np

# =================== C·∫§U H√åNH ===================
INPUT_DIR = r"D:\data container\·∫£nh ƒë√£ crop"      # Folder ch·ª©a ·∫£nh g·ªëc
OUTPUT_DIR = r"D:\data container\digit_data"   # Folder l∆∞u ·∫£nh crop
os.makedirs(OUTPUT_DIR, exist_ok=True)

ref_point = []
cropping = False
crop_count = 0  # ƒê·∫øm s·ªë crop trong m·ªói ·∫£nh

# =================== H√ÄM CLICK ===================
def click_and_crop(event, x, y, flags, param):
    global ref_point, cropping, image, clone
    if event == cv2.EVENT_LBUTTONDOWN:
        ref_point = [(x, y)]
        cropping = True
    elif event == cv2.EVENT_LBUTTONUP:
        ref_point.append((x, y))
        cropping = False
        # V·∫Ω rectangle t·∫°m th·ªùi
        cv2.rectangle(image, ref_point[0], ref_point[1], (0, 255, 0), 2)
        cv2.imshow("image", image)

# =================== X·ª¨ L√ù T·ª™NG ·∫¢NH ===================
for filename in os.listdir(INPUT_DIR):
    if filename.lower().endswith(('.png', '.jpg', '.jpeg')):
        path = os.path.join(INPUT_DIR, filename)
        
        # ƒê·ªçc ·∫£nh an to√†n v·ªõi ƒë∆∞·ªùng d·∫´n ti·∫øng Vi·ªát
        try:
            with open(path, 'rb') as f:
                file_bytes = np.asarray(bytearray(f.read()), dtype=np.uint8)
                image = cv2.imdecode(file_bytes, cv2.IMREAD_COLOR)
        except:
            print(f"‚ö†Ô∏è Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c ·∫£nh: {filename}")
            continue

        if image is None:
            print(f"‚ö†Ô∏è Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c ·∫£nh: {filename}")
            continue

        clone = image.copy()
        cv2.namedWindow("image")
        cv2.setMouseCallback("image", click_and_crop)
        crop_count = 0

        while True:
            cv2.imshow("image", image)
            key = cv2.waitKey(1) & 0xFF

            if key == ord("r"):  # Reset v√πng crop hi·ªán t·∫°i
                image = clone.copy()
                print("üîÑ Reset v√πng crop hi·ªán t·∫°i")
            elif key == ord("s"):  # L∆∞u v√πng crop
                if len(ref_point) == 2:
                    roi = clone[ref_point[0][1]:ref_point[1][1],
                                ref_point[0][0]:ref_point[1][0]]
                    save_name = f"{os.path.splitext(filename)[0]}_crop{crop_count}.png"
                    save_path = os.path.join(OUTPUT_DIR, save_name)
                    cv2.imwrite(save_path, roi)
                    print(f"‚úÖ ƒê√£ l∆∞u: {save_path}")
                    crop_count += 1
                    ref_point = []  # reset v√πng crop sau khi l∆∞u
                    image = clone.copy()  # x√≥a rectangle v·∫Ω tr∆∞·ªõc ƒë√≥
            elif key == ord("n"):  # Chuy·ªÉn sang ·∫£nh ti·∫øp theo
                print(f"‚è≠ Chuy·ªÉn sang ·∫£nh ti·∫øp theo: {filename}")
                break
            elif key == ord("q"):  # B·ªè qua ·∫£nh
                print(f"‚è© B·ªè qua ·∫£nh: {filename}")
                break

cv2.destroyAllWindows()
print("üéâ Ho√†n t·∫•t crop t·∫•t c·∫£ ·∫£nh!")
